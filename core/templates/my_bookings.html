{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Bookings - Royal Cars</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <link href="{% static 'img/favicon.ico' %}" rel="icon">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Rubik&display=swap" rel="stylesheet"> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <style>

    .page-header {
      background-color: #212529;
      color: white;
      padding: 4rem 0;
      text-align: center;
    }
    .page-header h1 {
      font-weight: 700;
      letter-spacing: 1px;
    }
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    th {
      background-color: #343a40 !important;
      color: white;
    }
    .badge {
      font-size: 0.9rem;
    }
    
  </style>
</head>
<body class="bg-light">
  <div class="container-fluid bg-dark py-3 px-lg-5 d-none d-lg-block">
        <div class="row">
            <div class="col-md-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body pr-3" href=""><i class="fa fa-phone-alt mr-2"></i>+012 345 6789</a>
                    <span class="text-body">|</span>
                    <a class="text-body px-3" href=""><i class="fa fa-envelope mr-2"></i>info@example.com</a>
                </div>
            </div>
            <div class="col-md-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body px-3" href=""><i class="fab fa-facebook-f"></i></a>
                    <a class="text-body px-3" href=""><i class="fab fa-twitter"></i></a>
                    <a class="text-body px-3" href=""><i class="fab fa-linkedin-in"></i></a>
                    <a class="text-body px-3" href=""><i class="fab fa-instagram"></i></a>
                    <a class="text-body pl-3" href=""><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>
    </div>
    <!-- Navbar Start -->
        <div class="container-fluid position-relative nav-bar p-0">
  <div class="position-relative px-lg-5" style="z-index: 9;">
    <nav class="navbar navbar-expand-lg bg-secondary navbar-dark py-3 py-lg-0 pl-3 pl-lg-5">
      <a href="/" class="navbar-brand">
        <h1 class="text-uppercase text-primary mb-1">Royal Cars</h1>
      </a>
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-between px-3" id="navbarCollapse">
        <div class="navbar-nav ml-auto py-0">
          <a href="{% url 'index' %}" class="nav-item nav-link">Home</a>
          <a href="{% url 'about' %}" class="nav-item nav-link">About</a>
          <a href="{% url 'service' %}" class="nav-item nav-link">Service</a>
          <a href="{% url 'car' %}" class="nav-item nav-link">Cars</a>
          <a href="{% url 'contact' %}" class="nav-item nav-link">Contact</a>

          {% if user.is_authenticated %}
              {% if user.role == "owner" %}
                  <a href="{% url 'owner_dashboard' %}" class="nav-item nav-link">Dashboard</a>
              {% else %}
                  <a href="{% url 'my_bookings' %}" class="nav-item nav-link">My Bookings</a>
                  <a href="{% url 'profile' %}" class="nav-item nav-link">Profile</a>
              {% endif %}
              <a href="{% url 'logout' %}" class="nav-item nav-link">Logout</a>
          {% else %}
              <a href="{% url 'login' %}" class="nav-item nav-link">Login</a>
              <a href="{% url 'register' %}" class="nav-item nav-link">Register</a>
              <a href="{% url 'register_owner' %}" class="nav-item nav-link">Register as Owner</a>
          {% endif %}
        </div>
      </div>
    </nav>
  </div>
</div>
    <!-- Navbar End -->


<!-- Alerts -->
{% if messages %}
  <div class="container mt-4">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Bookings Table -->
<div class="container my-5">
  <div class="card p-4">
    <h3 class="text-center text-primary mb-4"><i class="fas fa-car"></i> My Bookings</h3>

    {% if bookings %}
      <div class="table-responsive">
        <table class="table table-hover text-center align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Car</th>
              <th>Pickup</th>
              <th>Drop</th>
              <th>Pickup Date</th>
              <th>Pickup Time</th>
              <th>Return Date</th>   
              <th>Return Time</th>  
              <th>Status</th>
              <th>Action</th>
              <th>Comment</th>
            </tr>
          </thead>
          <tbody>
          {% for booking in bookings %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ booking.car.name }}</td>
              <td>{{ booking.pickup_location }}</td>
              <td>{{ booking.drop_location }}</td>
              <td>{{ booking.pickup_date }}</td>
              <td>{{ booking.pickup_time }}</td>
              <td>{{ booking.return_date }}</td>
              <td>{{ booking.return_time }}</td> 
              <td>
                {% if booking.status == "pending" %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif booking.status == "approved" %}
                  <span class="badge bg-success">Approved</span>
                {% elif booking.status == "rejected" %}
                  <span class="badge bg-danger">Rejected</span>
                {% elif booking.status == "paid" %}
                  <span class="badge bg-primary">Paid</span>
                {% else %}
                  <span class="badge bg-secondary">{{ booking.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if booking.status == "approved" %}
                  <a href="{% url 'pay_booking' booking.id %}" class="btn btn-sm btn-success">
                    üí≥ Pay Now
                  </a>
                {% elif booking.status == "paid" %}
                  <span class="text-success fw-bold">‚úÖ Paid</span>
                {% elif booking.status == "pending" %}
                  <span class="text-warning fw-bold">‚è≥ Waiting</span>
                {% elif booking.status == "rejected" %}
                  <span class="text-danger fw-bold">‚ùå Rejected</span>
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>
              {% if True %}
                <button class="btn btn-sm btn-outline-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#commentModal{{ booking.id }}">
                  ‚úçÔ∏è Add Comment
                </button>

                <!-- Modal -->
                <div class="modal fade" id="commentModal{{ booking.id }}" tabindex="-1" aria-labelledby="commentLabel{{ booking.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="commentLabel{{ booking.id }}">Add Comment for {{ booking.car.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <form method="POST" action="{% url 'add_comment' booking.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                          <label class="form-label">Rating (1‚Äì5)</label>
                          <input type="number" name="rating" min="1" max="5" value="5" class="form-control mb-3" required>

                          <label class="form-label">Your Comment</label>
                          <textarea name="comment" class="form-control" rows="4" placeholder="Write your experience..." required></textarea>
                        </div>
                        <div class="modal-footer">
                          <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              {% elif booking.has_comment %}
                <span class="text-success fw-bold">‚úÖ Comment Added</span>
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info text-center">
        You don't have any bookings yet.
      </div>
    {% endif %}
  </div>
</div>
<!-- üîí ÿπŸÇÿØ ÿßŸÑÿ™ÿ£ÿ¨Ÿäÿ± - ŸÖŸàÿØÿßŸÑ ÿ±ÿ≥ŸÖŸä -->
<div class="modal fade" id="contractModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="border:2px solid #ff6600; border-radius:14px; overflow:hidden; font-family:'Poppins', sans-serif;">
      
      <!-- Header -->
      <div class="modal-header" style="background:#111; color:white;">
        <h4 class="modal-title">
          <i class="bi bi-file-earmark-text"></i> Vehicle Rental Agreement
        </h4>
      </div>

      <!-- Body -->
      <div class="modal-body" style="background:#fff;">
        <div class="contract-paper" style="max-height:480px; overflow-y:auto; border:1px solid #ccc; padding:35px 40px; border-radius:8px; background:#fdfdfd; box-shadow:inset 0 0 8px rgba(0,0,0,0.05);">

          <div style="text-align:center; margin-bottom:15px;">
            <h3 style="font-weight:700; color:#111;">ROYAL CARS RENTAL AGREEMENT</h3>
            <p style="font-size:14px; color:#666;">Date: <b>{% now "F d, Y" %}</b></p>
          </div>

          <p>
            This Rental Agreement ("Agreement") is made between 
            <b>
              {% if booking.car.owner and booking.car.owner.company_name %}
                {{ booking.car.owner.company_name }}
              {% else %}
                Royal Cars Company
              {% endif %}
            </b> (‚Äúthe Company‚Äù) and 
            <b>{{ request.user.get_full_name|default:request.user.username }}</b> (‚Äúthe Renter‚Äù).
          </p>

          <h5 style="margin-top:20px; color:#ff6600;">1. Vehicle Information</h5>
          {% if booking %}
            <p>
              The rented vehicle is identified as <b>{{ booking.car.name }}</b>. 
              The vehicle shall be provided in good mechanical condition, free of known defects.
            </p>
          {% else %}
            <p>The rented vehicle details are currently unavailable.</p>
          {% endif %}

          <h5 style="margin-top:20px; color:#ff6600;">2. Rental Period</h5>
          {% if booking %}
            <p>
              The rental period begins on <b>{{ booking.pickup_date }}</b> 
              and ends on <b>{{ booking.return_date }}</b>, as mutually agreed upon by both parties.
            </p>
          {% else %}
            <p>Rental dates are unavailable.</p>
          {% endif %}

          <h5 style="margin-top:20px; color:#ff6600;">3. Responsibilities</h5>
          <ul>
            <li>The Renter shall operate the vehicle safely and in accordance with all traffic laws.</li>
            <li>The Renter is responsible for any fines, penalties, or damages incurred during the rental period.</li>
            <li>Smoking, racing, or illegal use of the vehicle is strictly prohibited.</li>
            <li>Fuel, maintenance, and cleanliness are the responsibility of the Renter during the rental period.</li>
          </ul>

          <h5 style="margin-top:20px; color:#ff6600;">4. Payment Terms</h5>
          {% if booking %}
            <p>
              Total payment of <b>${{ booking.car.price }}</b> has been received successfully through Stripe. 
              The payment confirms the Renter‚Äôs acceptance of this agreement.
            </p>
          {% else %}
            <p>Payment details are not available.</p>
          {% endif %}

          <h5 style="margin-top:20px; color:#ff6600;">5. Liability & Insurance</h5>
          <p>
            The Renter assumes full responsibility for the vehicle while in possession. 
            Insurance coverage applies as per company policy.
          </p>

          <h5 style="margin-top:20px; color:#ff6600;">6. Termination</h5>
          <p>
            The Company reserves the right to terminate this agreement and repossess the vehicle 
            in case of violation of any term herein.
          </p>

          <h5 style="margin-top:20px; color:#ff6600;">7. Acceptance</h5>
          <p>
            By scrolling to the end and clicking ‚ÄúI Agree‚Äù, the Renter acknowledges having read 
            and fully understood all terms of this agreement.
          </p>

          <div style="margin-top:35px; border-top:1px solid #ccc; padding-top:15px;">
            <p><b>Renter‚Äôs Name:</b> {{ request.user.get_full_name|default:request.user.username }}</p>
            <p><b>Signature:</b> ____________________________</p>
            <p><b>Date:</b> {% now "F d, Y" %}</p>
          </div>

        </div>

        <div id="scrollNotice" class="text-center mt-3" style="font-size:14px; color:#777;">
          ‚¨áÔ∏è Please scroll to the bottom of the contract to enable the ‚ÄúI Agree‚Äù button.
        </div>

        <div class="text-center mt-4">
          <label style="font-size:15px;">
            <input type="checkbox" id="agreeBox" style="margin-right:6px;"> 
            I have read and agree to all terms of this contract.
          </label>
        </div>
      </div>

      <!-- Footer -->
        <div class="modal-footer" style="background:#111;">

          <!-- üßæ ÿßŸÑŸÅŸàÿ±ŸÖ ÿßŸÑŸÑŸä Ÿäÿ±ÿ≥ŸÑ ŸÖŸàÿßŸÅŸÇÿ© ÿßŸÑÿπŸÇÿØ -->
          <form id="contractForm" method="POST" action="{% url 'approve_contract' %}">
            {% csrf_token %}
            <input type="hidden" name="booking_id" id="bookingIdInput" value="">
            <button id="agreeBtn" type="submit"
                    class="btn"
                    style="background:#ff6600; color:white; border:none; padding:10px 35px; font-size:16px; border-radius:6px; transition:0.2s;"
                    disabled>
              ‚úÖ I Agree
            </button>
          </form>

        </div>

    </div>
  </div>
</div>

      <!-- footer        //////////////////////   -->
    <div class="container-fluid bg-secondary py-5 px-sm-3 px-md-5" style="margin-top: 90px;">
        <div class="row pt-5">
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Get In Touch</h4>
                <p class="mb-2"><i class="fa fa-map-marker-alt text-white mr-3"></i>123 Street, New York, USA</p>
                <p class="mb-2"><i class="fa fa-phone-alt text-white mr-3"></i>+012 345 67890</p>
                <p><i class="fa fa-envelope text-white mr-3"></i>info@example.com</p>
                <h6 class="text-uppercase text-white py-2">Follow Us</h6>
                <div class="d-flex justify-content-start">
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-twitter"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square" href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Useful Links</h4>
                <div class="d-flex flex-column justify-content-start">
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Private Policy</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Terms & Conditions</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>New Member Registration</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Affiliate Programme</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Return & Refund</a>
                    <a class="text-body" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Help & FAQs</a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Car Gallery</h4>
                <div class="row mx-n1">
                    <div class="col-4 px-1 mb-2"><a href="#"><img class="w-100" src="{% static 'img/gallery-1.jpg' %}" alt=""></a></div>
                    <div class="col-4 px-1 mb-2"><a href="#"><img class="w-100" src="{% static 'img/gallery-2.jpg' %}" alt=""></a></div>
                    <div class="col-4 px-1 mb-2"><a href="#"><img class="w-100" src="{% static 'img/gallery-3.jpg' %}" alt=""></a></div>
                    <div class="col-4 px-1 mb-2"><a href="#"><img class="w-100" src="{% static 'img/gallery-4.jpg' %}" alt=""></a></div>
                    <div class="col-4 px-1 mb-2"><a href="#"><img class="w-100" src="{% static 'img/gallery-5.jpg' %}" alt=""></a></div>
                    <div class="col-4 px-1 mb-2"><a href="#"><img class="w-100" src="{% static 'img/gallery-6.jpg' %}" alt=""></a></div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Newsletter</h4>
                <p class="mb-4">Subscribe to get the latest updates and offers.</p>
                <div class="w-100 mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark border-dark" style="padding: 25px;" placeholder="Your Email">
                        <div class="input-group-append">
                            <button class="btn btn-primary text-uppercase px-3">Sign Up</button>
                        </div>
                    </div>
                </div>
                <i>Lorem sit sed elitr sed kasd et</i>
            </div>
        </div>
    </div>

    <div class="container-fluid bg-dark py-4 px-sm-3 px-md-5">
        <p class="mb-2 text-center text-body">&copy; <a href="#">Royal Cars</a>. All Rights Reserved.</p>
        <p class="m-0 text-center text-body">Designed by <a href="https://htmlcodex.com">A&M Group</a></p>
    </div>

    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- end footer        ////////////////////// -->
     <script>
document.addEventListener("DOMContentLoaded", function() {
  const params = new URLSearchParams(window.location.search);
  const showContract = params.get("show_contract");
 const bookingId = params.get("booking") || params.get("booking_id");

  if (showContract === "true" && bookingId) {
    const modalEl = document.getElementById("contractModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    const agreeBox = document.getElementById("agreeBox");
    const agreeBtn = document.getElementById("agreeBtn");
    const contractBox = document.querySelector(".contract-paper");
    const scrollNotice = document.getElementById("scrollNotice");
    window.contractAccepted = false;

    // üîí ŸÖŸÜÿπ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿ•ŸÑÿß ÿ®ÿπÿØ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©
    modalEl.addEventListener('hide.bs.modal', function(e) {
      if (!window.contractAccepted) e.preventDefault();
    });

    let scrolledToBottom = false;

    // ‚úÖ ÿ™ÿ≠ŸÇŸÇ ÿ•ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿµŸÑ ŸÑŸÜŸáÿßŸäÿ© ÿßŸÑŸÜÿµ
    contractBox.addEventListener("scroll", function() {
      const scrollPosition = contractBox.scrollTop + contractBox.clientHeight;
      const scrollHeight = contractBox.scrollHeight;

      if (scrollPosition >= scrollHeight - 10) {
        scrolledToBottom = true;
        scrollNotice.textContent = "‚úÖ You can now click 'I Agree' to accept the contract.";
        checkIfCanEnable();
      }
    });

    // ‚úÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ŸÅŸÇÿ∑ ÿ®ÿπÿØ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± + ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ checkbox
    agreeBox.addEventListener("change", checkIfCanEnable);

    function checkIfCanEnable() {
      if (scrolledToBottom && agreeBox.checked) {
        agreeBtn.disabled = false;
      } else {
        agreeBtn.disabled = true;
      }
    }

    // ‚úÖ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©
    agreeBtn.addEventListener("click", function() {
      fetch("{% url 'approve_contract' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "booking_id=" + bookingId
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          window.contractAccepted = true;
          modal.hide();
          alert("‚úÖ Contract accepted successfully!");
          window.location.replace("/my-bookings/");
        } else {
          alert("‚ö†Ô∏è Something went wrong while approving the contract.");
        }
      })
      .catch(err => {
        console.error("Error:", err);
        alert("‚ö†Ô∏è Network error. Please try again.");
      });
    });
  }
});
</script>
</body>
</html>